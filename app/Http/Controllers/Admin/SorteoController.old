<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\Sorteo;
use App\Models\Jugada;
use App\Events\BolillaSorteada;
use App\Events\LineaConfirmada;
use App\Events\BingoConfirmado;

class SorteoController extends Controller
{
    public function ver($jugadaId)
    {
        $jugada = Jugada::findOrFail($jugadaId);

        $sorteo = Sorteo::where('jugada_id', $jugadaId)
            ->latest()
            ->firstOrFail();

        return view('sorteador.jugada', compact('jugada', 'sorteo', 'jugadaId'));
    }

    public function extraer(Request $request, $jugadaId)
    {
        $sorteo = Sorteo::where('jugada_id', $jugadaId)
            ->where('estado', 'en_curso')
            ->latest()
            ->firstOrFail();

        $sacadas = $sorteo->bolillas_sacadas ?? [];

        // Corte total: ya salieron las 90 bolillas
        if (count($sacadas) >= 90) {
            $sorteo->estado = 'finalizado';
            $sorteo->save();
            return back()->with('error', 'Ya salieron todas las bolillas. Sorteo finalizado.');
        }

        do {
            $nueva = rand(1, 90);
        } while (in_array($nueva, $sacadas));

        $sacadas[] = $nueva;

        $sorteo->bolilla_actual = $nueva;
        $sorteo->bolillas_sacadas = $sacadas;
        $sorteo->save();

        $ultimas = array_slice(array_reverse($sacadas), 0, 5);

        event(new BolillaSorteada(
            (int) $jugadaId,
            (int) $nueva,
            $ultimas
        ));

        return back();
    }

    // El operador confirma que hay una lÃ­nea
    public function confirmarLinea(Request $request, $jugadaId)
    {
        $sorteo = Sorteo::where('jugada_id', $jugadaId)->latest()->firstOrFail();
        $sorteo->estado = 'linea';
        $sorteo->save();

        $cartonId = $request->input('carton_id');

        event(new LineaConfirmada(
            (int) $jugadaId,
            (int) $cartonId
        ));

        return back();
    }

    // Luego de pagar la lÃ­nea, se reanuda el juego
    public function reanudar($jugadaId)
    {
        $sorteo = Sorteo::where('jugada_id', $jugadaId)->latest()->firstOrFail();
        $sorteo->estado = 'en_curso';
        $sorteo->save();

        return back();
    }

    // El operador confirma que hay Bingo
    public function confirmarBingo(Request $request, $jugadaId)
    {
        $sorteo = Sorteo::where('jugada_id', $jugadaId)->latest()->firstOrFail();
        $sorteo->estado = 'bingo';
        $sorteo->save();

        $cartonId = $request->input('carton_id');

        event(new BingoConfirmado(
            (int) $jugadaId,
            (int) $cartonId
        ));

        return back();
    }

    // Finaliza completamente la jugada
    public function finalizar($jugadaId)
    {
        $sorteo = Sorteo::where('jugada_id', $jugadaId)->latest()->firstOrFail();
        $sorteo->estado = 'finalizado';
        $sorteo->save();

        return back();
    }
}
